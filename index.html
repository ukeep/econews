<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel=stylesheet href="css/newsclip.css">

    <title>SSEC Leader ecoNews</title>

    <script type="text/javascript" src="js/infinite-scroll.js"></script>

    <script>
        initVars: {
            var jsonUrl = "stories.txt";
            var linkPrefix = "https://drive.google.com/uc?export=download&id=";
            //        var thumbPrefix = "https://drive.google.com/thumbnail?sz=h200&id=";
            var thumbPrefix = linkPrefix;
            var sharePrefix = "https://drive.google.com/file/d/";
            var shareSuffix = "/view?usp=sharing";
            var maxheaderPercent = 0.10; // 0.07;
            var headerHeight, hideHeader, lastScrollTop;
            var headerShown = true;

            var onlinePrefix = "http://www.theleader.com.au/story/";
            var paperName = "Sutherland Shire Leader";
            var paperTwitterHandle = "@theleadernews";
            var hashtag = "econews";

            var firstDate = "2013-01-01";
            var lastDate = dayString(new Date()); // If a fixed last date, use "yyyy-mm-dd"
            var searchHint = "Search title or author";

            var active = ["black", "#f8ecb9", "normal"];
            var inactive = ["grey", "white", "italic"];
            var col = 0,
                bg = 1,
                fs = 2;

            var showMargin = 10; // Margin between edge of window and full size news image

            var next = 0; // Next story to display when scrolling to end of page 
            var bucket = 7; // Number of stories loaded to page at a time
            var scrollSensor = 50; // Add more content if within this distance of page end
            var filter = {};
            var searchStart = true;

            var stories = [];

            var month = new Array("January", "February", "March",
                "April", "May", "June",
                "July", "August", "September",
                "October", "November", "December");

            var scrollbarWidth = 17;
            var justShown = false;

            var timeout;
            if (navigator.userAgent.search("Firefox") > 0 ||
                navigator.userAgent.search("Chrome/18") > 0 ||
                //                navigator.userAgent.search("Edge") > 0 ||
                false) {
                timeout = 1000;
            } else {
                timeout = 0;
            }

            var writeNotice = true;
        }

        function handleJson() {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                stories = JSON.parse(xmlhttp.responseText);
                document.getElementById("loadStories").style.display = "none";
                writeStories(true);

                var scrollOptions = {
                    distance: scrollSensor,
                    callback: function(done) {
                        writeStories();
                        done();
                    }
                }

                infiniteScroll(scrollOptions); // setup infinite scroll
            }
        }
        // Open JSON file containing stories
        var xmlhttp = new XMLHttpRequest();
        xmlhttp.onreadystatechange = (timeout > 0) ?
            setTimeout(handleJson, timeout) : handleJson;
        xmlhttp.open("GET", jsonUrl, true);
        xmlhttp.send();

        function clearFilter() {
            filter.fromDate = firstDate;
            filter.toDate = lastDate;
            filter.person = "";
            filter.topics = "";
            filter.search = "";
            setInputs();

        };

        function setInputs() {
            document.getElementById("fromDate").value = filter.fromDate;
            document.getElementById("toDate").value = filter.toDate;
            document.getElementById("topic").value = filter.topics;
            document.getElementById("person").value = filter.person;
            document.getElementById("search").value =
                (searchStart) ? searchHint : filter.search;

            document.getElementById("fromDate").style.color =
                (filter.fromDate != firstDate) ? active[col] : inactive[col];
            document.getElementById("fromDate").style.backgroundColor =
                (filter.fromDate != firstDate) ? active[bg] : inactive[bg];

            document.getElementById("toDate").style.color =
                (filter.toDate != lastDate) ? active[col] : inactive[col];
            document.getElementById("toDate").style.backgroundColor =
                (filter.toDate != lastDate) ? active[bg] : inactive[bg];
            document.getElementById("topic").style.color =
                (filter.topics) ? active[col] : inactive[col];
            document.getElementById("topic").style.backgroundColor =
                (filter.topics) ? active[bg] : inactive[bg];
            document.getElementById("person").style.color =
                (filter.person) ? active[col] : inactive[col];
            document.getElementById("person").style.backgroundColor =
                (filter.person) ? active[bg] : inactive[bg];
            document.getElementById("search").style.color =
                (filter.search && !searchStart) ? active[col] : inactive[col];
            document.getElementById("search").style.backgroundColor =
                (filter.search && !searchStart) ? active[bg] : inactive[bg];
        }

        function writeStories(reset) {
            if (reset) {
                writeNotice = true;
                next = 0;
                nStories = 0;
                document.getElementById("stories").innerHTML = "";
                window.scrollTo(0, 0);
                reset = false;
            }
            var j = 0;
            for (var i = next; i < stories.length; i++) {
                if (fitsThru(stories[i])) {
                    document.getElementById("stories").innerHTML += formatStory(stories[i]);
                    j++;
                }
                next++;
                if (j >= bucket) break;
            }
            nStories += j;
            if (i == stories.length && writeNotice) {
                var notice;
                switch (nStories) {
                    case 0:
                        notice = "No items match";
                        break;
                    case 1:
                        notice = "1 item matches";
                        break;
                    default:
                        notice = nStories + " items match";
                }
                notice += " your search/filter.";
                if (nStories == 0) {
                    notice += " <span class='noWrap'><a href='javascript:clearFilter(); writeStories(true)'>Clear search/filter</a></span>.";
                }

                document.getElementById("stories").innerHTML +=
                    "<div class='story'><span class='notice'>" + notice +
                    "</span></div>";
                writeNotice = false;
            }
        }

        function fitsThru(s) {
            return s.date.substr(0, 10) >= filter.fromDate &&
                s.date.substr(0, 10) <= filter.toDate &&
                (filter.person == "" || s.person.search(filter.person) > -1) &&
                (filter.topics == "" || s.topics.search(filter.topics) > -1) &&
                (filter.search == "" ||
                    s.title.search(filter.search) > -1 ||
                    s.author.search(filter.search) > -1);
        };

        function formatStory(s) {

            var storyDiv = "<div class='story'>";

            // Paper border around each story - dropped in favour of thumb border
            // storyDiv += "<div class='paper-shadow paper-shadow-top'></div>";
            // storyDiv += "<div class='paper-shadow paper-shadow-bottom'></div>";

            detailsDiv: {
                storyDiv += "<div class='details'>";

                storyDiv += "<h2>" + s.title + "</h2>";

                byline: {
                    if (s.author || s.online) {
                        storyDiv += "<p class='byline'>";
                        if (s.online != "") {
                            storyDiv += "<a href='" + onlinePrefix + s.online + "' target=_blank><img class='textBtn' src='images/online.svg' title='Read online'></a> ";
                        }
                        storyDiv += s.author + "</p>";
                    }
                }

                tagline: {
                    storyDiv += "<p class='tagline'>"
                    if (s.topics != "") {
                        storyDiv += " <img class='textIcon' src='images/topic.svg' title='Topics tagged in this story'>";
                        var topicList = s.topics.split(", ");
                        for (var i = 0; topicList[i]; i++) {
                            storyDiv += " <a href='javascript:;' onClick='clearFilter(); filter.topics=\"" + topicList[i] + "\"; setInputs(); writeStories(true)'>" + topicList[i] + "</a>";
                        }
                    }
                    if (s.person != "") {
                        storyDiv += " <img class='textIcon' src='images/person.svg' title='People tagged in this story'>";
                        var personList = s.person.split(", ");
                        for (var i = 0; personList[i]; i++) {
                            storyDiv += " <a href='javascript:;' onClick='clearFilter(); filter.person=\"" + personList[i] + "\"; setInputs(); writeStories(true)'>" + personList[i] + "</a>";
                        }
                    }

                    storyDiv += "</p>"
                }

                citeline: {
                    storyDiv += "<p class='citeline'>" + "<span class='noWrap'>" + paperName + ",</span> ";

                    var d = new Date(s.date);
                    var dateString = month[d.getMonth()] + " " +
                        d.getDate() + " " +
                        d.getFullYear();

                    var shortDate = month[d.getMonth()].substr(0, 3) + " " + d.getDate();

                    storyDiv += "<span class='noWrap'>" + "<a href='javascript:;' onClick='clearFilter(); filter.fromDate=\"" +
                        s.date + "\"; filter.toDate=\"" +
                        s.date + "\"; setInputs(); writeStories(true)'>" +
                        dateString + "</a></span>";

                    storyDiv += " &ndash; page " + s.page + "</p>";
                }

                shareBtns: {
                    var shareLink = encodeURIComponent(sharePrefix + s.link + shareSuffix);

                    storyDiv += "<div class='shareBtns'><a href='https://www.facebook.com/sharer/sharer.php?u=" + shareLink + "' target='_blank'><img class='textBtn' src='images/fb_share.svg' title='Share on Facebook'></a>"

                    var tweet = s.title + " - " + s.author + " ";
                    tweet += paperTwitterHandle || paperName;
                    tweet += " " + shortDate;
                    tweet += (d.getFullYear() == new Date().getFullYear()) ?
                        "" : " " + d.getFullYear(); // Add year if not this year
                    tweet = tweet.replace(/\'/g, "%27");

                    storyDiv += " <a href='https://twitter.com/intent/tweet?text=" + tweet + "&url=" + shareLink + "&hashtags='" + hashtag + "' target='_blank'><img class='textBtn' src='images/tweet.svg' title='Tweet this story'></a>";

                    var body = '"' + s.title + '"\n' +
                        s.author + ", " + paperName + " " + dateString + "\n\n";
                    body = encodeURIComponent(body) +
                        linkPrefix.replace(/\&/g, "%26") + s.link;

                    var mailLink = "mailto:?subject=" + encodeURIComponent(s.title) +
                        "&body=" + body;
                    storyDiv += " <a href=" + mailLink + " target='_blank'><img class='textBtn' src='images/mail.svg' title='Mail this story'></a>";

                    storyDiv += "</div>";
                }

                storyDiv += "</div>";
            }

            thumbDiv: {
                storyDiv += "<div class='thumb'>";
                storyDiv += "<a name='" + s.link + "'></a>";

                // Drop loadImg: not appearing till main image loads anyway
                // storyDiv += "<img class='loadImg' src='images/loadimg.svg'>";

                storyDiv += "<a href='#" + s.link + "'>";
                storyDiv += "<img class='thumbImg'  onclick=clickImg(this) src='" +
                    thumbPrefix + s.link + "' onload=\"if(this.parentElement) this.parentElement.previousElementSibling.style.display='none'\"></a>";

                storyDiv += "<div class='paper-shadow paper-shadow-top'></div>";
                storyDiv += "<div class='paper-shadow paper-shadow-bottom'></div>";

                storyDiv += "</div>";
            }

            storyDiv += "</div>";

            storyDiv += "<hr>";

            return storyDiv;
        }

        function search() {
            var s = document.getElementById('search').value.trim().replace('\n', '');
            var sStyle = document.getElementById('search').style;
            if (!searchStart) {
                filter.search = RegExp(s, 'i');
                writeStories(true)
            }
            if (s && !searchStart) {
                sStyle.backgroundColor = active[bg];
                sStyle.color = active[col];
                sStyle.fontStyle = active[fs];
            } else {
                sStyle.color = inactive[col];
                sStyle.backgroundColor = inactive[bg];
            }
        }

        function clickImg(thumb) {
            var imgBox = document.getElementById("imgBox");

            if (document.getElementById("show").style.display === "initial") {
                if (justShown) {
                    justShown = false;
                    return;
                }
                document.body.style.overflow = "auto";
                document.getElementById("show").style.display = "none";
                imgBox.style.width = "auto";
                imgBox.style.opacity = 0;
                window.removeEventListener("resize", vscrollOutside);
                window.removeEventListener("hashchange", clickImg);
                if (location.hash) {
                    history.back();
                }
            } else {
                document.getElementById("show").style.display = "initial";
                document.body.style.overflow = "hidden";
                document.getElementById("showImg").src =
                    thumb.src.replace(thumbPrefix, linkPrefix);

                vscrollOutside();

                imgBox.scrollTop = 0;
                imgBox.scrollLeft = 0;

                imgBox.style.opacity = 1;
                window.addEventListener("resize", vscrollOutside, false);
                justShown = true;
                window.addEventListener("hashchange", clickImg, false);
            }
        }

        // If only vertical scrollbar on image, put it outside
        function vscrollOutside() {
            var imgBox = document.getElementById("imgBox");
            if (imgBox.scrollHeight > imgBox.offsetHeight &&
                imgBox.scrollWidth == imgBox.offsetWidth) {
                imgBox.style.width = imgBox.offsetWidth + scrollbarWidth;
            }
        }

        function dayString(d) {
            var t = d.getFullYear() + "-";
            t += (d.getMonth() < 9) ? "0" : "";
            t += d.getMonth() + 1 + "-";
            t += (d.getDate() < 10) ? "0" : "";
            t += d.getDate();
            return t

        }

        // Show filter/search tools when user scrolls up but not at top
        function checkHeight() {
            headerHeight = document.getElementById("header").scrollHeight;
            document.getElementById("stories").style.top = headerHeight;
            hideHeader = headerHeight > window.innerHeight * maxheaderPercent;

            // Show filter/search tools when user scrolls up
            if (hideHeader) {
                lastScrollTop = 0;
                window.addEventListener("scroll", scrollHeader, false);
            } else {
                window.removeEventListener("scroll", scrollHeader);
                document.getElementById("header").style.top = 0;
                document.getElementById("header").style.width = document.body.clientWidth; // Recover width lost by position fixed
            }
        }

        window.addEventListener("resize", checkHeight, false);

        function scrollHeader() {
            var st = window.pageYOffset || document.documentElement.scrollTop;
            if (st < lastScrollTop) { // Scroll up
                if (headerShown) {
                    if (st < headerHeight && document.getElementById("header").style.top != '0px') {
                        document.getElementById("header").style.top =
                            Math.max(-headerHeight, -st);
                    }
                } else {
                    document.getElementById("header").style.top = 0;
                    headerShown = true;
                }
            } else { // Scroll down
                if (headerShown || lastScrollTop < headerHeight) {
                    if (st < headerHeight) {
                        document.getElementById("header").style.transitionProperty = 'none';
                        document.getElementById("header").style.top =
                            Math.max(-headerHeight, -st);
                    } else {
                        document.getElementById("header").style.transitionProperty = 'top';
                        document.getElementById("header").style.top = -headerHeight;
                        headerShown = false;
                    }
                }
            }
            lastScrollTop = st;
        }

    </script>
</head>

<body onload="clearFilter(); checkHeight()">
    <div id="header">
        <div class='paper-shadow paper-shadow-top'></div>
        <div class='paper-shadow paper-shadow-bottom'></div>

        <div id="headerBlock">
            <span class="logo"><img src=images/logo.png width=auto height=35>SSEC Leader ecoNews</span>
            <span class="noWrap">
                <div class="filterCell">
                    <label for="fromDate"><img src=images/date.svg width=auto height=22.5 title="Filter by date range"></label>
                    <input type=date id="fromDate" value=firstDate onmouseover="this.style.color=active[col]" onmouseout="this.style.color=(this.value == firstDate) ? inactive[col] : active[col]" onchange="if(!this.value) this.value=firstDate; filter.fromDate=this.value; writeStories(true); this.style.color = (this.value == firstDate) ? inactive[col] : active[col]; this.style.backgroundColor = (this.value == firstDate) ? inactive[bg] : active[bg];">
                </div>
                <div class="filterCell">
                    <label class="toDate" for="toDate"><img src=images/dash.svg width=auto height=22.5></label>
                    <input type=date id="toDate" onmouseover="this.style.color=active[col]"  onmouseout="this.style.color = (this.value == lastDate) ? inactive[col] : active[col]" onchange="if(!this.value) this.value=lastDate; filter.toDate=this.value; writeStories(true); this.style.color = (this.value == lastDate) ? inactive[col] : active[col]; this.style.backgroundColor = (this.value == lastDate) ? inactive[bg] : active[bg];">
                </div>
            </span>
            <div class=" filterCell ">
                <label for="topic"><img src=images/topic.svg width=auto height=20 title="Filter by topic"></label>
                <select id=topic onmouseover="this.style.color=active[col]" onmouseout="this.style.color = (this.value) ? active[col] : inactive[col];" onchange="filter.topics=this.value; writeStories(true); this.style.color = (this.value) ? active[col] : inactive[col]; this.style.backgroundColor = (this.value) ? active[bg] : inactive[bg];">
                    <option value="" selected>(all)</option>
                    <option value="Bushland">Bushland</option>
                    <option value="Climate">Climate</option>
                    <option value="Marine">Marine</option>
                    <option value="Planning">Planning</option>
                    <option value="Politics">Politics</option>
                    <option value="Refugees">Refugees</option>
                    <option value="Transport">Transport</option>
                    <option value="Vegetarianism">Vegetarianism</option>
                    <option value="Waste">Waste</option>
                    <option value="Water">Water</option>
                </select>
            </div>
            <div class="filterCell">
                <label for="person"><img src=images/person.svg width=auto height=20 title="Filter by person"></label>
                <select id=person onmouseover="this.style.color=active[col]" onmouseout="this.style.color = (this.value) ? active[col] : inactive[col];" onchange="filter.person=this.value; writeStories(true); this.style.color = (this.value) ? active[col] : inactive[col]; this.style.backgroundColor = (this.value) ? active[bg] : inactive[bg];">
                    <option value="" selected>(all)</option>
                    <option value="AR">Anne Robinson</option>
                    <option value="BR">Bill Ryan</option>
                    <option value="BW">Bob Walshe</option>
                    <option value="BE">Brian Everingham</option>
                    <option value="CR">Colin Ryan</option>
                    <option value="GS">Gary Schoer</option>
                    <option value="GH">Gordon Hocking</option>
                    <option value="JG">Jenni Gormley</option>
                    <option value="JF">Jenny Fitzgerald</option>
                    <option value="JD">Jonathan Doig</option>
                    <option value="JW">Judy Walker</option>
                    <option value="LH">Lloyd Hodges</option>
                    <option value="MS">Murray Scott</option>
                    <option value="PS">Phil Smith</option>
                    <option value="RC">Rick Cavicchioli</option>
                    <option value="SM">Sue McKinnon</option>
                    <option value="SSEC">Suth Shire Envt Centre</option>
                    <option value="TK">Tassia Kolesnikow</option>
                </select>
            </div>
            <div class="filterCell">
                <input type=text id=search value="Search" onkeydown="if (event.keyCode == 13) {document.getElementById('searchBtn').click()}" onClick=" this.style.color=active[col]; this.style.fontStyle=active[fs]; if(searchStart) {this.value=''; searchStart = false}">
            </div>
            <div class="filterCell">
                <a href="javascript:;">
                    <img id=searchBtn src=images/search.svg width=auto height=25 onMouseOver=this.src='images/searchon.svg' onMouseOut=this.src='images/search.svg' onClick="search()" title="Search">
                </a>
            </div>
            <div class="filterCell">
                <a href="javascript:clearFilter(); writeStories(true)">
                    <img id="clearBtn" src=images/clear.svg width=auto height=25 onMouseOver=this.src='images/clearon.svg' onMouseOut=this.src='images/clear.svg' alt="Clear search/filter">
                </a>
            </div>
        </div>
    </div>
    <div id="stories">
        <div id="loadStories">Loading...</div>
    </div>

    <div id="show" onClick=clickImg() title="Click anywhere to close">
        <div id="imgBox">
            <img id="showImg">
        </div>
    </div>
    <div id="footer"></div>
</body>

</html>
